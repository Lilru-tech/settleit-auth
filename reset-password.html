<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password - SettleIt</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <link rel="icon" type="image/png" href="images/favicon.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
</head>
<body>
  <!-- ‚úÖ Header -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(response => response.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
      })
      .catch(error => console.error("Error loading header:", error));
  </script>

  <!-- ‚úÖ Contenido principal -->
  <div class="main-content">
    <div class="container">
      <h1>üîí Reset Your Password</h1>
      <p>Enter your new password below:</p>

      <input type="password" id="new-password" placeholder="New Password" class="input-field" required />
      <input type="password" id="confirm-password" placeholder="Confirm Password" class="input-field" required />

      <button id="reset-btn" class="button">Reset Password</button>

      <!-- Spinner -->
      <div id="loading-spinner" class="hidden">
        <div class="spinner"></div>
        <p>Processing...</p>
      </div>

      <!-- Mensaje de resultado -->
      <p id="message" class="hidden"></p>
    </div>
  </div>

  <!-- ‚úÖ Footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(response => response.text())
      .then(data => {
        document.getElementById("footer-placeholder").innerHTML = data;
      })
      .catch(error => console.error("Error loading footer:", error));
  </script>

  <!-- ‚úÖ Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://auth.settleit.me", 
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyd2RuempxcnFheWhtbWh4b2N1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM4NjYwMTcsImV4cCI6MjA0OTQ0MjAxN30.aYsVh89BxXpmT1q-1eyu7-_obmPUqIUjBTxWa6nMtgM"
    );
  </script>

  <!-- ‚úÖ Detectar access_token del hash y limpiar la URL -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get("access_token");
  
      if (accessToken) {
        console.log("‚úÖ access_token detectado:", accessToken);
  
        try {
          const { error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: ""
          });
  
          if (error) {
            console.error("‚ùå Error al iniciar sesi√≥n con token:", error);
            alert("Error restoring session. Please try again.");
          } else {
            console.log("‚úÖ Sesi√≥n iniciada correctamente con el access_token.");
          }
  
          window.history.replaceState(null, null, window.location.pathname);
        } catch (e) {
          console.error("‚ùå Error inesperado:", e);
        }
      } else {
        console.warn("‚ö†Ô∏è No access_token encontrado en el hash.");
      }
    });
  </script>

  <!-- ‚úÖ L√≥gica para cambiar la contrase√±a -->
  <script>
    document.getElementById("reset-btn").addEventListener("click", async () => {
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;
      const message = document.getElementById("message");
      const spinner = document.getElementById("loading-spinner");

      message.classList.add("hidden");
      spinner.classList.remove("hidden");

      if (newPassword !== confirmPassword) {
        spinner.classList.add("hidden");
        message.innerText = "‚ùå Passwords do not match.";
        message.classList.add("error");
        message.classList.remove("hidden");
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        spinner.classList.add("hidden");

        if (error) {
          console.error("‚ùå Error al actualizar contrase√±a:", error);
          message.innerText = `‚ùå ${error.message || "Unexpected error. Please try again."}`;
          message.classList.add("error");
          message.classList.remove("hidden");
        } else {
          message.innerText = "‚úÖ Password reset successfully! Redirecting to login...";
          message.classList.add("success");
          message.classList.remove("hidden");

          setTimeout(() => {
            window.location.href = "index.html";
          }, 4000);
        }
      } catch (err) {
        spinner.classList.add("hidden");
        console.error("‚ùå Network error:", err);
        message.innerText = "‚ùå Network error. Please try again.";
        message.classList.add("error");
        message.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>