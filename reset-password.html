<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - SettleIt</title>
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div id="header-placeholder"></div>
    <script>
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header-placeholder").innerHTML = data;
            })
            .catch(error => console.error("Error loading header:", error));
    </script>

    <div class="main-content">
        <div class="container">
            <h1>üîí Reset Your Password</h1>
            <p>Enter your new password below:</p>

            <input type="password" id="new-password" placeholder="New Password" required>
            <input type="password" id="confirm-password" placeholder="Confirm Password" required>

            <button id="reset-btn">Reset Password</button>

            <div id="loading-spinner" class="hidden">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>

            <p id="message" class="hidden"></p>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <script>
        fetch("footer.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("footer-placeholder").innerHTML = data;
            })
            .catch(error => console.error("Error loading footer:", error));
    </script>

    <script>
        document.getElementById("reset-btn").addEventListener("click", async function() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const newPassword = document.getElementById("new-password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            const message = document.getElementById("message");
            const spinner = document.getElementById("loading-spinner");

            message.classList.add("hidden");
            spinner.classList.remove("hidden");

            if (!code) {
                message.innerText = "Invalid or expired reset link.";
                message.classList.remove("hidden");
                spinner.classList.add("hidden");
                return;
            }

            if (newPassword !== confirmPassword) {
                message.innerText = "Passwords do not match.";
                message.classList.remove("hidden");
                spinner.classList.add("hidden");
                return;
            }

            try {
                const response = await fetch("https://auth.settleit.me/auth/v1/user", {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${code}`
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                spinner.classList.add("hidden");

                if (response.ok) {
                    message.innerText = "‚úÖ Password reset successfully! Redirecting to login...";
                    message.classList.add("success");
                    
                    // Redirigir al login despu√©s de 5 segundos
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 5000);
                } else {
                    message.innerText = "‚ùå Error resetting password. Please try again.";
                    message.classList.add("error");
                }

                message.classList.remove("hidden");
            } catch (error) {
                spinner.classList.add("hidden");
                message.innerText = "‚ùå Network error. Please try again.";
                message.classList.add("error");
                message.classList.remove("hidden");
            }
        });
    </script>

    <style>
        .hidden { display: none; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }

        /* Estilos para el spinner */
        .spinner {
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

</body>
</html>